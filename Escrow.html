<!-- 
  This HTML file is licensed under the terms of the LICENSE.

  Copyright (C) [2023] [TrustLink]

  You can find the full text of the license in the LICENSE file, or you can obtain it at the following URL: ./license

  The license permits you to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of this software, subject to the terms and conditions specified in the license.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escrow Contract Interaction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.9.0/web3.min.js"></script>
</head>
<body>
    <h1>Escrow Contract Interaction</h1>
    <button id="connect">Connect MetaMask</button>
    <button id="disconnect" disabled>Disconnect MetaMask</button>
	<h2>Connected Account: <span id="account"></span></h2>
    <h2>Create Escrow</h2>
    <label for="recipients">Recipients (comma separated):</label>
    <input type="text" id="recipients" placeholder="0xRecipient1,0xRecipient2">
    <label for="amount">Amount (ETH):</label>
    <input type="number" id="amount" min="0" step="any">
    <button id="createEscrow">Create Escrow</button>
    <h2>Negotiate Escrow</h2>
    <label for="negotiatedAmount">Escrow ID:</label>
    <input type="number" id="negotiatedEscrowId" min="0">
    <label for="negotiatedAmount">Negotiated Amount (ETH):</label>
    <input type="number" id="negotiatedAmount" min="0" step="any">
    <button id="negotiateEscrow">Negotiate Escrow</button>
    <h2>Fulfill Escrow</h2>
    <label for="fulfillEscrowId">Escrow ID:</label>
    <input type="number" id="fulfillEscrowId" min="0">
    <button id="fulfillEscrow">Fulfill Escrow</button>
    <h2>Contract Balance</h2>
    <button id="getBalance">Get Balance</button>
    <p id="balance"></p>
    <h2>Get Escrow Info</h2>
    <label for="displayEscrowInfoById">Escrow ID:</label>
    <input type="number" id="escrowInfoId" name="escrowInfoId" placeholder="Enter escrow ID">
    <button id="displayEscrowInfoById">Get Escrow Info</button>
    <p id="escrowInfo"></p>
    <h2>Get Next Escrow ID</h2>
    <button id="getNextEscrowId" onclick="displayNextEscrowId()">Get Next Escrow ID</button>
    <p id="nextId"></p>
    <br><br>
    <script>
        let web3;
        let contract;
        const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "_recipients",
				"type": "address[]"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "createEscrow",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EscrowCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "EscrowFulfilled",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "fulfillEscrow",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_negotiatedAmount",
				"type": "uint256"
			}
		],
		"name": "negotiateEscrow",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			}
		],
		"name": "RecipientAdded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "escrows",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "negotiated_amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isFulfilled",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "getEscrowRecipients",
		"outputs": [
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextEscrowId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
        const contractAddress = "0x2067392415504A1b58bb79FE2E5E12d4910899f6";

        document.getElementById("connect").addEventListener("click", connectMetaMask);
        document.getElementById("disconnect").addEventListener("click", disconnectMetaMask);
        document.getElementById("createEscrow").addEventListener("click", createEscrow);
        document.getElementById("negotiateEscrow").addEventListener("click", negotiateEscrow);
        document.getElementById("fulfillEscrow").addEventListener("click", fulfillEscrow);
        document.getElementById("getBalance").addEventListener("click", getContractBalance);
        document.getElementById("displayEscrowInfoById").addEventListener("click", displayEscrowInfoById);

        async function connectMetaMask() {
            if (typeof window.ethereum === "undefined") {
                alert("MetaMask not found. Please install MetaMask and try again.");
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                account = await web3.eth.getAccounts();
                account = account[0];
                
                document.getElementById("account").innerText = account;
                
                document.getElementById("connect").disabled = true;
                document.getElementById("disconnect").disabled = false;
            } catch (error) {
                console.error("Error connecting to MetaMask:", error);
                alert("Failed to connect to MetaMask.");
            }
        }

        function disconnectMetaMask() {
            web3 = null;
            contract = null;
            document.getElementById("connect").disabled = false;
            document.getElementById("disconnect").disabled = true;
		}
		
		async function createEscrow() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }

            const recipients = document.getElementById("recipients").value.split(",");
            const amount = document.getElementById("amount").value;

            try {
                const accounts = await web3.eth.getAccounts();
                const weiAmount = web3.utils.toWei(amount, "ether");
                await contract.methods.createEscrow(recipients, weiAmount).send({ from: accounts[0], value: weiAmount });
                alert("Escrow created successfully.");
            } catch (error) {
                console.error("Error creating escrow:", error);
                alert("Failed to create escrow.");
            }
        }

        async function negotiateEscrow() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }

            const escrowId = document.getElementById("negotiatedEscrowId").value;
            const negotiatedAmount = document.getElementById("negotiatedAmount").value;

            try {
                const accounts = await web3.eth.getAccounts();
                const weiAmount = web3.utils.toWei(negotiatedAmount, "ether");
                await contract.methods.negotiateEscrow(escrowId, weiAmount).send({ from: accounts[0] });
                alert("Escrow negotiated successfully.");
            } catch (error) {
                console.error("Error negotiating escrow:", error);
                alert("Failed to negotiate escrow.");
            }
        }

        async function fulfillEscrow() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }

            const fulfillEscrowId = document.getElementById("fulfillEscrowId").value;

            try {
                const accounts = await web3.eth.getAccounts();
                await contract.methods.fulfillEscrow(fulfillEscrowId).send({ from: accounts[0] });
                alert("Escrow fulfilled successfully.");
            } catch (error) {
                console.error("Error fulfilling escrow:", error);
                alert("Failed to fulfill escrow.");
            }
        }

        async function getContractBalance() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }

            try {
                const balance = await contract.methods.getContractBalance().call();
                const etherBalance = web3.utils.fromWei(balance, "ether");
                document.getElementById("balance").innerText = `Contract balance: ${etherBalance} ETH`;
            } catch (error) {
                console.error("Error getting contract balance:", error);
                alert("Failed to get contract balance.");
            }
        }
        
        async function getEscrowInfo(escrowId) {
            console.log("Escrow ID:", escrowId);
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }
            
            try {
                const escrowInfo = await contract.methods.escrows(escrowId).call();
                const recipients = await contract.methods.getEscrowRecipients(escrowId).call();
                
                //console.log("Raw Escrow Info:", escrowInfo);
        
                const formattedEscrowInfo = {
                    sender: escrowInfo.sender,
                    recipients: recipients,
                    amount: escrowInfo.amount,
                    negotiated_amount: escrowInfo.negotiated_amount,
                    isFulfilled: escrowInfo.isFulfilled,
                };

                console.log("Escrow Info:", formattedEscrowInfo);
                return formattedEscrowInfo;
            } catch (error) {
                console.error("Error fetching escrow info:", error);
            }
        }

        async function getNextEscrowId() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }
            
            try {
                const id = await contract.methods.nextEscrowId().call();
                console.log("Next Escrow ID:", id);
                return id;
            } catch (error) {
                console.error("Error fetching next escrow ID:", error);
            }
        }
        
        async function displayEscrowInfoById() {
            
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }
            
            const escrowId = document.getElementById("escrowInfoId").value;
            const escrowInfo = await getEscrowInfo(escrowId);
            //console.log("Raw Escrow Info:", escrowInfo);
            document.getElementById("escrowInfo").innerText = JSON.stringify(escrowInfo, null, 2);
        }

        async function displayNextEscrowId() {
            if (!contract) {
                alert("Please connect MetaMask first.");
                return;
            }
            
            try {
                const id = await contract.methods.nextEscrowId().call();
                console.log("Next Escrow ID:", id);
                document.getElementById("nextId").innerText = id;
            } catch (error) {
                console.error("Error fetching next escrow ID:", error);
                document.getElementById("nextId").innerText = "Error fetching next escrow ID:" . error;
            }
        }
    </script>
</body>
</html>
