<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Interaction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.9.0/web3.min.js"></script>
</head>
<body>
    <h1>KPI Interaction</h1>
	<div id="walletConnectionStatus">Not connected to wallet</div>
    <div id="kpiInfo" style="display: none;"></div>
    <button id="connectWallet">Connect Wallet</button>
    <h2>Create KPI Point</h2>
    <label for="kpiThreshold">KPI Threshold:</label>
    <input type="number" id="kpiThreshold" name="kpiThreshold">
    <br>
    <label for="kpiPath">KPI Path:</label>
    <input type="text" id="kpiPath" name="kpiPath">
    <br>
    <label for="kpiUrl">KPI URL:</label>
    <input type="text" id="kpiUrl" name="kpiUrl">
    <br>
    <button id="createKPI">Create KPI Point Value</button>

    <h2>Fetch KPI Point Value</h2>
    <label for="kpiIdUpdate">KPI ID:</label>
    <input type="text" id="kpiIdUpdate" name="kpiIdUpdate">
    <br>
    <label for="newValue">New Value:</label>
    <input type="number" id="newValue" name="newValue">
    <br>
    <button id="updateKPI">Fetch KPI Point Value</button>

    <h2>Delete KPI Point</h2>
    <label for="kpiIdDelete">KPI ID:</label>
    <input type="text" id="kpiIdDelete" name="kpiIdDelete">
    <br>
    <button id="deleteKPI">Delete KPI Point</button>

    <h2>Get KPI Point Last Value</h2>
    <label for="kpiIdGet">KPI ID:</label>
    <input type="text" id="kpiIdGet" name="kpiIdGet">
    <br>
    <button id="getKPI">Get KPI Point Last Value</button>
    <pre id="kpiDetails"></pre>
	
	<h2>Get All KPI Points:</h2>
	<button id="listKPIs">List All KPI Points</button>
	<div id="kpisList"></div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const contractAddress = urlParams.get('contract');
    const escrowId = urlParams.get('escrowId');

    if (!contractAddress || !escrowId) {
      alert('Contract address and escrow ID are required.');
      window.location.href = 'Escrow.php';
    }
    
    let web3;
    let kpiContract;
    let userAddress;
    const kpiContractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_kpiThreshold",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_kpiPath",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_kpiUrl",
				"type": "string"
			}
		],
		"name": "createKPIPoint",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_kpiId",
				"type": "bytes32"
			}
		],
		"name": "deleteKPIPoint",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_kpiId",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "_newValue",
				"type": "uint256"
			}
		],
		"name": "fetchKPIPointValue",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_escrow",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "kpiId",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "kpiThreshold",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "kpiPath",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "kpiUrl",
				"type": "string"
			}
		],
		"name": "KPICreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "kpiId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "KPIDeleted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "kpiId",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "kpiValue",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "kpiViolationStatus",
				"type": "bool"
			}
		],
		"name": "KPIUpdated",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "escrow",
		"outputs": [
			{
				"internalType": "contract IEscrow",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "escrowKPIs",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "getEscrowKPIs",
		"outputs": [
			{
				"internalType": "bytes32[]",
				"name": "",
				"type": "bytes32[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_kpiId",
				"type": "bytes32"
			}
		],
		"name": "getKPILastValue",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "kpiThreshold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "kpiValue",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "kpiPath",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "kpiViolationStatus",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"name": "kpis",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "kpiId",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "kpiThreshold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "kpiValue",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "kpiPath",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "kpiUrl",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "kpiViolationStatus",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "kpiViolationPaid",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "escrowContract",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];


//////////////////////

//////////////////////

//////////////////////

//////////////////////

//////////////////////

//////////////////////

    const escrowContractABI = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EscrowCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "EscrowFulfilled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "kpiContractAddress",
				"type": "address"
			}
		],
		"name": "KPIContractAddressSet",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			}
		],
		"name": "RecipientAdded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "_recipients",
				"type": "address[]"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "createEscrow",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "escrows",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "negotiated_amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isFulfilled",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "fulfillEscrow",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "getEscrowRecipients",
		"outputs": [
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getNextEscrowId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			}
		],
		"name": "isFulfilled",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "kpiContractAddresses",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_negotiatedAmount",
				"type": "uint256"
			}
		],
		"name": "negotiateEscrow",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextEscrowId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_escrowId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_kpiContractAddress",
				"type": "address"
			}
		],
		"name": "setKPIContractAddress",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];
    
    const connectWalletButton = document.getElementById('connectWallet');

        async function init() {
    		if (window.ethereum) {
        		web3 = new Web3(window.ethereum);
        		await window.ethereum.request({ method: 'eth_requestAccounts' });
        		account = (await web3.eth.getAccounts())[0];
				userAddress = (await web3.eth.getAccounts())[0];
        		kpiContract = new web3.eth.Contract(kpiContractABI, contractAddress);

        		// Fetch the Escrow contract address
        		const escrowAddress = await kpiContract.methods.escrow().call();
        		const escrowContract = new web3.eth.Contract(escrowContractABI, escrowAddress);

        		// Fetch the Escrow owner
        		const escrows = await escrowContract.methods.escrows(escrowId).call();
				const sender = escrows.sender;

        		// Fetch all the Escrow recipients
        		const recipients = await escrowContract.methods.getEscrowRecipients(escrowId).call();
        		//alert(recipients);
        		// Verify the account is the same as the Escrow owner or a recipient
        		const isOwner = account.toLowerCase() === sender.toLowerCase();
        		const isRecipient = recipients.some(recipient => account.toLowerCase() === recipient.toLowerCase());

        		if (!isOwner && !isRecipient) {
            		alert('Connected account does not match the Escrow owner or any recipient.');
            		window.location.href = 'Escrow.php';
        		}

        		// Hide the Connect Wallet button
        		connectWalletButton.style.display = 'none';
				
				// Hide the "Not connected to wallet" message
    			document.getElementById('walletConnectionStatus').style.display = 'none';

				
				// Show and populate the KPI information
            const kpiInfo = document.getElementById('kpiInfo');
            kpiInfo.style.display = 'block';
            const data = {
                "KPI Contract": contractAddress,
                "Escrow Contract": escrowAddress,
                "EscrowID": escrowId,
                "Escrow Sender": sender,
                "Escrow Recipients": recipients.join('<br>')
            };

            for (const key in data) {
                const p = document.createElement('p');
                p.className = 'kpi-info';
                const label = document.createElement('span');
                label.className = 'kpi-label';
                label.innerText = key + ': ';
                p.appendChild(label);
                const value = document.createElement('span');
                value.className = 'kpi-value';
                value.innerHTML = data[key];
                p.appendChild(value);
                kpiInfo.appendChild(p);
            }
    		} else {
        		alert('Please install MetaMask or another web3-compatible wallet to interact with this page.');
    		}
		}

    async function createKPIPoint() {
		console.log(escrowId);
        const kpiThreshold = document.getElementById("kpiThreshold").value;
        const kpiPath = document.getElementById("kpiPath").value;
		const kpiUrl = document.getElementById("kpiUrl").value;
        await kpiContract.methods.createKPIPoint(kpiThreshold, kpiPath, escrowId, kpiUrl).send({ from: userAddress });
    }

    async function fetchKPIPointValue() {
        const kpiId = document.getElementById("kpiIdUpdate").value;
        const newValue = document.getElementById("newValue").value;
        await kpiContract.methods.fetchKPIPointValue(kpiId, newValue).send({ from: userAddress });
    }

    async function deleteKPIPoint() {
        const kpiId = document.getElementById("kpiIdDelete").value;
        await kpiContract.methods.deleteKPIPoint(kpiId).send({ from: userAddress });
    }

    async function getKPIPointLastValue() {
        const kpiId = document.getElementById("kpiIdGet").value;
        const kpiDetails = await kpiContract.methods.getKPIPointLastValue(kpiId).call({ from: userAddress });
        document.getElementById("kpiDetails").innerText = JSON.stringify(kpiDetails, null, 2);
    }

	async function getAllKPIPoints() {
		
		const kpiIds = await kpiContract.methods.getEscrowKPIs(escrowId).call();
    		//console.log(kpiIds);
			
			const kpisListElement = document.getElementById('kpisList');
    		kpisListElement.innerHTML = '';

    		for (const kpiId of kpiIds) {
        		const kpi = await kpiContract.methods.getKPI(kpiId).call();
        		const kpiElement = document.createElement('p');
        		kpiElement.innerHTML = `
            		KPI ID: ${kpiId}<br>
            		Threshold: ${kpi.kpiThreshold}<br>
            		Value: ${kpi.kpiValue}<br>
            		Path: ${kpi.kpiPath}<br>
            		Violation Status: ${kpi.kpiViolationStatus}
        		`;
        		kpisListElement.appendChild(kpiElement);
    		}
	}
    
    connectWalletButton.onclick = init;
        
        document.getElementById("connectWallet").addEventListener("click", init);
        document.getElementById("createKPI").addEventListener("click", createKPIPoint);
        document.getElementById("updateKPI").addEventListener("click", fetchKPIPointValue);
        document.getElementById("deleteKPI").addEventListener("click", deleteKPIPoint);
        document.getElementById("getKPI").addEventListener("click", getKPIPointLastValue);
		document.getElementById("listKPIs").addEventListener("click", getAllKPIPoints);

</script>
</body>
</html>
